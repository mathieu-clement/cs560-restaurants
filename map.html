<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 500px;
        width: 100%;
       }

       #inspectionContent {
           max-height: 200px;
           overflow-y: scroll;
       }

       #score {
           font-weight: bold;
       }

       .high-risk-violation {
           color: red;
       }

       .moderate-risk-violation {
           color: orange;
       }

       .low-risk-violation {
           color: darkgray;
       }
    </style>
  </head>
  <body>
    <h3>Restaurants</h3>
    <div id="map"></div>
    <script>
      function initMap() {
        var sanfrancisco = {lat: 37.773972, lng: -122.431297};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: sanfrancisco
        });

        var lastOpenedInfoWindow = new google.maps.InfoWindow();

        $.getJSON("combined.json", function(dataset) {
            console.log(dataset[31]);

            var markers = [];
            
            $.each(dataset, function(business_id, data) {
                var contentString = 
                    '<div id="content">' +
                        '<h2 id="firstHeading">' + data.name + '</h2>' +
                        '<div id="bodyContent">' +
                        '<p>Rating: ' + data.rating + ' (' + data.review_count + ' review' + (data.review_count > 1 ? 's' : '')  + ' on <a href="' + data.url + '">Yelp</a>) </p>' +
                            '<h3>Inspections</h3>' +
                            '<div id="inspectionContent"' + 
                            '<ul>';
                data.inspections.reverse();
                $.each(data.inspections, function(i, inspection) {

                     contentString += 
                         '<li>Score of <span id="score">' + 
                         inspection.score + '</span> on ' + inspection.date + 
                            (inspection.violations.length > 0 ? ':' : '') + 
                            '<ul>';

                     inspection.violations.reverse();

                     $.each(inspection.violations, function(j, violation) {
                         var riskClass = "low-risk-violation";
                         if (violation.risk == "High Risk") 
                            riskClass = "high-risk-violation";
                         else if (violation.risk == "Moderate Risk")
                            riskClass = "moderate-risk-violation";

                         contentString += '<li class="' + riskClass + '">' + 
                            violation.description + '</li>';
                     });

                     contentString +=
                            '</ul>' + 
                        '</li>';
                });
                contentString +=
                            '</ul>' +
                          '</div>' +
                        '</div>' +
                    '</div>';

                var infowindow = new google.maps.InfoWindow({
                        content: contentString
                        });
                
                var latLng = new google.maps.LatLng(
                        data.coordinates.latitude, 
                        data.coordinates.longitude);

                var marker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        title: data.name
                        });
                marker.addListener('click', function() {
                        lastOpenedInfoWindow.close();
                        lastOpenedInfoWindow = infowindow;
                        infowindow.open(map, marker);
                        });
                markers.push(marker);
            });

            var markerCluster = new MarkerClusterer(map, markers, {
                imagePath: './m'
                });
        });
      }
    </script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
    <script src="markerclusterer.js"
       ></script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIvScuubyyrqxWj81j6UUsqO_1LoqnH3A&callback=initMap">
    </script>
  </body>
</html>
