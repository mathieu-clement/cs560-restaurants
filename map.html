<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 500px;
        width: 100%;
       }

       #inspectionContent {
           max-height: 200px;
           overflow-y: scroll;
       }

       #score {
           font-weight: bold;
       }

       #inspectionContent ul {
           margin-top: 0em;
       }

       .high-risk-violation {
           color: red;
       }

       .moderate-risk-violation {
           color: orange;
       }

       .low-risk-violation {
           color: darkgray;
       }
    </style>
  </head>
  <body>
    <h3>Restaurants</h3>
    <div id="map"></div>
    <div id="filters">
        <h1 id="loading">Loading...</h1>
        <p>Price range: <select id="price-range"></select></p>
        <p>Category: <select id="cuisine"></select></p>
        <p>Score range: <select id="min-score"></select> to <select id="max-score"></select></p>
    </div>
    <script>
      window.filters = [];
      window.filtersById = {};

      function arrayJoin(parts, sep){
          var separator = sep || ', ';
          var replace   = new RegExp(separator+'{1,}', 'g');
          return parts.join(separator).replace(replace, separator);
      }

      function onlyUnique(value, index, self) { 
          return self.indexOf(value) === index;
      }

      function findAllUniqueValues(dataset, fieldAccessor, flat, arrayAccessor) {
          // If flat, must unwrap all values from fieldAccessor
          // as it returned an array
          var values = [];
          var arrays = dataset
                      .map(function(el) { return fieldAccessor(el); });
          if (flat) {
              for (var i in arrays) {
                  var arr = arrays[i];
                  for (var j in arr) {
                      var val = arr[j];
                      values.push(arrayAccessor(val));
                  }
              }
          } else {
              values = arrays;
          }
          values = values.filter(onlyUnique);
          values.sort();
          return values;
      }

      function fillValues(selectId, values) {
          var select = $(selectId);

          select.append('<option value="any">Any</option>');

          for (var i in values) {
              var value = values[i];
              if (typeof value == "undefined") continue;
              select.append('<option value="' + value + '">' + 
                            value + '</option>');
          }
      }

      function andFilters(filters) {
          return function (d) {
              for (var i in filters) {
                  var filter = filters[i];
                  if (!filter(d)) {
                      return false;
                  }
              }
              return true;
          };
      }

      function resetMarkers(dataset, filters) {
           window.markerClusterer.clearMarkers();
           window.markerClusterer.addMarkers(getMarkers(dataset, 
                      andFilters(filters)));
      }


      function addFilter(selectId, dataset, fieldAccessor, flat, arrayAccessor, comparator) {
          var flat = flat || false;
          var comparator = comparator || function(filterVal, datasetVal) {
              return filterVal == datasetVal;
          };
          var values = findAllUniqueValues(Object.values(dataset), 
                                           fieldAccessor,
                                           flat,
                                           arrayAccessor);
          fillValues(selectId, values);

          if (flat) {
              // includes
              $(selectId).change(function() {
                 var newVal = $(selectId).val();
                 console.log("New value for " + selectId, newVal);
                 var id = filters.indexOf(filtersById[selectId]);
                 if (id !== -1) filters.splice(id, 1);

                 var filter2 = function(el) {
                         var arr = fieldAccessor(el);
                         for (var i in arr) {
                            var val = arrayAccessor(arr[i]);
                            if (comparator(newVal, val)) return true;
                         }
                         return false;
                     };
                 if (newVal != "any") {
                     filters.push(filter2);
                 }
                 filtersById[selectId] = filter2;
                 resetMarkers(dataset, filters);
                 });
          } else {
              // equals
              $(selectId).change(function() {
                 var newVal = $(selectId).val();
                 console.log("New value for " + selectId, newVal);
                 var id = filters.indexOf(filtersById[selectId]);
                 if (id !== -1) filters.splice(id, 1);
                 var filter2 = function(el) {
                         return comparator(newVal, fieldAccessor(el));
                     };
                 if (newVal != "any") {
                     filters.push(filter2);
                 }
                 filtersById[selectId] = filter2;
                 resetMarkers(dataset, filters);
              });
          }
      }

      function getMarkers(dataset, filter) {
            var markers = [];
            var filter = filter || function(el) { return true; };
            
            $.each(dataset, function(business_id, data) {
                if (!filter(data)) return;
                var contentString = 
                    '<div id="content">' +
                        '<h2 id="firstHeading">' + data.name + '</h2>' +
                        '<div id="bodyContent">' +
                        '<p>' + arrayJoin(data.location.display_address) + '</p>' +
                        '<p>' + arrayJoin(data.categories.map(c => c.title)) + '</p>' +
                        '<p>Rating: ' + data.rating + ' (' + data.review_count + ' review' + (data.review_count > 1 ? 's' : '')  + ' on <a href="' + data.url + '">Yelp</a>) </p>' +
                            '<h3>Inspections</h3>' +
                            '<div id="inspectionContent"' + 
                            '<ul>';
                data.inspections.reverse();
                $.each(data.inspections, function(i, inspection) {

                     contentString += 
                         '<li>Score of <span id="score">' + 
                         inspection.score + '</span> on ' + inspection.date + 
                            (inspection.violations.length > 0 ? ':' : '') + 
                            '<ul>';

                     inspection.violations.reverse();

                     $.each(inspection.violations, function(j, violation) {
                         var riskClass = "low-risk-violation";
                         if (violation.risk == "High Risk") 
                            riskClass = "high-risk-violation";
                         else if (violation.risk == "Moderate Risk")
                            riskClass = "moderate-risk-violation";

                         contentString += '<li class="' + riskClass + '">' + 
                            violation.description + '</li>';
                     });

                     contentString +=
                            '</ul>' + 
                        '</li>';
                });
                contentString +=
                            '</ul>' +
                          '</div>' +
                        '</div>' +
                    '</div>';

                var infowindow = new google.maps.InfoWindow({
                        content: contentString
                        });
                
                var latLng = new google.maps.LatLng(
                        data.coordinates.latitude, 
                        data.coordinates.longitude);

                var marker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        title: data.name,
                        label: ''+ data.inspections[0].score
                        });
                marker.addListener('click', function() {
                        lastOpenedInfoWindow.close();

                        // Toggle visibility if same marker is clicked
                        if (infowindow == lastOpenedInfoWindow) {
                           lastOpenedInfoWindow = new google.maps.InfoWindow(); 
                           return;
                        }

                        lastOpenedInfoWindow = infowindow;
                        infowindow.open(map, marker);
                        });
                markers.push(marker);
            });
            
            return markers;
      }

      function initMap() {
        var sanfrancisco = {lat: 37.773972, lng: -122.431297};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: sanfrancisco,
          styles: [
              {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [
                          { visibility: "off" }
                    ]
              }
          ]
        });
        window.map = map;

        var lastOpenedInfoWindow = new google.maps.InfoWindow();
        window.lastOpenedInfoWindow = lastOpenedInfoWindow;

        $.getJSON("combined.json", function(dataset) {
            console.log(dataset[31]);
            window.dataset = dataset;

            $().ready(function(){
                    addFilter('#price-range', dataset, function(el) { 
                              return el['price']; });
                    addFilter('#cuisine', dataset, 
                              function(el) { return el['categories']; },
                              true,
                              function(item) { return item['title']; });
                    addFilter('#min-score', dataset, function(el) {
                              return el['inspections'][el['inspections'].length-1]['score'];
                              }, false, null, function(filterVal, datasetVal) {
                                  return datasetVal >= parseInt(filterVal);
                              }); 
                    addFilter('#max-score', dataset, function(el) {
                              return el['inspections'][el['inspections'].length-1]['score'];
                              }, false, null, function(filterVal, datasetVal) {
                                  return datasetVal <= parseInt(filterVal);
                              }); 
                    $('#loading').remove();
            });

            var markers = getMarkers(dataset);

            var markerClusterer = new MarkerClusterer(map, markers, {
                imagePath: './m',
                maxZoom: 17
                });
            window.markerClusterer = markerClusterer;
        });
      }
    </script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
    <script src="markerclusterer.js"
       ></script>
    <!-- Customize map using https://mapstyle.withgoogle.com/ -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIvScuubyyrqxWj81j6UUsqO_1LoqnH3A&callback=initMap">
    </script>
  </body>
</html>
