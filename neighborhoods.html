<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Line chart</title>
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<style type="text/css">
    .label {
		font-family: Helvetica, sans-serif;
        font-size: 10px;
        text-anchor: middle;
        pointer-events: none; /* Ignore mouseover over label */
    }

    .neighborhood-name {
		font-family: Helvetica, sans-serif;
        font-size: 14px;
    }

    path {
        stroke: black; /* outline */
    }
</style>
</head>
<body>
	<script type="text/javascript">
		const w = 500;
		const h = 380;

        var sanfrancisco = [-122.45, 37.78];

        var projection = d3.geoMercator()
                           .center(sanfrancisco)
                           .translate([w/2, h/2])
                           .scale([160000]);

        var path = d3.geoPath()
                     .projection(projection);

        var formatDecimals = d3.format(".3");

		var svg = d3
            .select("body")
            .append("svg")
            .attr("width", w + 100)
            .attr("height", h + 100)
            ;

        var g = svg.append("g")
                   .style("opacity", 0.0);

        var rect = g.append("rect")
           .attr("x", 20)
           .attr("y", 10)
           .attr("width", 300)
           .attr("height", 30)
           .attr("fill", "white")
           .attr("stroke", "black")
           ;

        var nhoodText = g.append("text")
            .attr("class", "neighborhood-name")
            .attr("x", 30)
            .attr("y", 30);

        // Our custom scale for scores, according to the SF Health Department
        var lessThan71 = "rgb(215,25,28)"; // red
        var lessThan86 = "rgb(253,174,97)"; // orange
        var lessThan90 = "rgb(255,255,191)"; // pale yellow/cream
        var moreThan90 = "rgb(166,217,106)"; // light green

        var colorScale = function(score) {
            if (score < 71) return lessThan71;
            if (score < 86) return lessThan86;
            if (score < 90) return lessThan90;
            return moreThan90;
        };

        /*
		svg.append("text")
		.attr("x", w/2)
		.attr("y", -30)
		.attr("dy", ".35em")
		.attr("font-size", 18)
		.attr("font-weight", "bold")
		.attr("fill", "black")
		.style("text-anchor", "middle")
		.text("Health score over time");
        */

        d3.json("neighborhoods.json").then(function(json) {
            d3.json("neighborhood_average_scores.json").then(function(data) {
                for (var i in json.features) {
                    var feature = json.features[i];
                    var nhood = feature.properties['nhood'];
                    feature.properties.average = data[nhood];
                }
            
                svg
                    .selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("fill", d => colorScale(d.properties.average))
                    .on("mouseover", function(d) {
                        g.transition().duration(500).style("opacity", 1.0);
                        nhoodText.text(d.properties.nhood);
                        d3.select(this)
                          .transition()
                          .duration(500)
                          .attr("fill", "pink");
                    })
                    .on("mouseout", function(d) {
                        g.transition().duration(500).style("opacity", 0.0);
                        d3.select(this)
                          .transition()
                          .duration(500)
                          .attr("fill", colorScale(d.properties.average));
                    })
                    ; 

                svg
                    .selectAll("text")
                    .data(json.features)
                    .enter()
                    .append("text")
                    .attr("class", "label")
                    .attr("x", function(d) { return path.centroid(d)[0]; })
                    .attr("y", function(d) { return path.centroid(d)[1]; })
                    .text(function(d) {
                        return formatDecimals(d.properties.average);
                    })
                    ;

            }); // d3.json avg scores
        }); // d3.json neighborhoods geoson
        
	</script>
</body>
</html>
